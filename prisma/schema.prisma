generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  GERENTE
  FINANCEIRO
  FUNCIONARIO
  RECEPCAO
}

// 2. Modelo de Agendamento
model Appointment {
  id          String   @id @default(cuid())
  date        DateTime
  reason      String
  notes       String?
  status      String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELED
  
  // === NOVOS CAMPOS FINANCEIROS ===
  totalCost   Decimal? @db.Decimal(10, 2) // Valor cobrado
  isPaid      Boolean  @default(false)      // Se já foi pago
  paymentMethod String?                     // PIX, CREDITO, etc.
  
  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])
  
  veterinarianId String
  veterinarian   User    @relation("VetAppointments", fields: [veterinarianId], references: [id])

  services Service[]

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  medicalRecord MedicalRecord?
  
  // Relacionamento com a transação financeira gerada
  transactions Transaction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 3. Modelo de Prontuário Médico
model MedicalRecord {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  
  complaint   String   // Queixa principal (Anamnese)
  diagnosis   String?  // Diagnóstico
  prescription String? @db.Text // Receita / Prescrição
  notes       String?  @db.Text // Exame físico / Detalhes

  appointmentId String? @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])

  veterinarianId String
  veterinarian   User    @relation("VetRecords", fields: [veterinarianId], references: [id])

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  document    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  modules     TenantModule[]

  transactions Transaction[]
  
  // Dados Módulo Creche
  customers   Customer[]
  pets        Pet[]
  kennels     Kennel[]
  bookings    Booking[]

  services Service[]
  products Product[]

  appointments    Appointment[]
  medicalRecords  MedicalRecord[]

  // Dados Módulo Equinos
  equineAnimals EquineAnimal[]
  reproductiveCycles ReproductiveCycle[]
  semenCollections SemenCollection[]
  inseminations Insemination[]

  // Dados Módulo Gado Leiteiro
  dairyAnimals DairyAnimal[]
  lactationCycles LactationCycle[]
  milkProductions MilkProduction[]

  // Dados Módulo Gado de Corte
  beefAnimals BeefAnimal[]
  beefLots BeefLot[]
  weighings Weighing[]

  // Dados Módulo Pet Sitter
  petSitterAppointments PetSitterAppointment[]
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  role        Role   @default(FUNCIONARIO) // GERENTE, FINANCEIRO, FUNCIONARIO, RECEPCAO
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())

  vetAppointments Appointment[] @relation("VetAppointments")
  vetRecords      MedicalRecord[] @relation("VetRecords")
}

model Module {
  id          String   @id
  name        String
  description String?
  price       Decimal  @default(0.0)

  tenants     TenantModule[]
}

model TenantModule {
  id        String   @id @default(cuid())
  tenantId  String
  moduleId  String
  isActive  Boolean  @default(true)
  expiresAt DateTime?

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  module    Module   @relation(fields: [moduleId], references: [id])

  @@unique([tenantId, moduleId])
}

// === ENTIDADES DO MÓDULO GERAL E CRECHE ===

model Customer {
  id          String   @id @default(cuid())
  name        String
  
  email       String?
  phone       String?
  address     String?
  cpf         String?

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  pets        Pet[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Pet {
  id          String   @id @default(cuid())
  name        String
  species     String
  breed       String?
  weight      Float?
  birthDate   DateTime?
  
  allergies   String?  
  foodRestrictions String? 
  vetName     String?  
  vetPhone    String?  
  notes       String?  

  ownerId     String
  owner       Customer @relation(fields: [ownerId], references: [id])
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  bookings    Booking[]
  medications PetMedication[] 
  logs        PetLog[]
  petSitterAppointments PetSitterAppointment[]        

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  appointments    Appointment[]
  medicalRecords  MedicalRecord[]
}

model PetMedication {
  id          String   @id @default(cuid())
  name        String   
  dosage      String   
  frequency   String   
  startDate   DateTime?
  endDate     DateTime?
  active      Boolean  @default(true)

  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])
  createdAt   DateTime @default(now())
}

model PetLog {
  id          String   @id @default(cuid())
  type        String   
  description String   
  date        DateTime @default(now())
  performedBy String?

  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])
  createdAt   DateTime @default(now())
}

model Kennel {
  id          String      @id @default(cuid())
  name        String
  size        String?     
  dailyRate   Decimal     @default(0.0) @db.Decimal(10, 2)
  status      String      @default("AVAILABLE") 
  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  bookings    Booking[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  capacity    Int      @default(1)
}

model Booking {
  id          String    @id @default(cuid())
  startDate   DateTime  @default(now()) 
  endDate     DateTime? 
  status      String    @default("ACTIVE") 

  totalCost   Decimal?  @db.Decimal(10, 2)
  
  transactions Transaction[]
  
  petId       String
  pet         Pet       @relation(fields: [petId], references: [id])
  
  kennelId    String
  kennel      Kennel    @relation(fields: [kennelId], references: [id])
  
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  services    BookingService[]
}

model Service {
  id          String   @id @default(cuid())
  name        String   
  price       Decimal  @db.Decimal(10, 2)
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  bookingServices BookingService[]

  appointments Appointment[]
  petSitterAppointments PetSitterAppointment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BookingService {
  id          String   @id @default(cuid())
  price       Decimal  @db.Decimal(10, 2) 
  createdAt   DateTime @default(now())

  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id])
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
}

// === MÓDULO REPRODUÇÃO DE EQUINOS ===

model EquineAnimal {
  id          String   @id @default(cuid())
  name        String
  type        String   // STALLION (Garanhão), DONOR (Doadora), RECIPIENT (Receptora)
  breed       String?
  birthDate   DateTime?
  registerNum String?

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  semenCollections SemenCollection[]
  cycles          ReproductiveCycle[]
  inseminations   Insemination[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ReproductiveCycle {
  id          String   @id @default(cuid())
  startDate   DateTime @default(now())
  endDate     DateTime?
  status      String   @default("OPEN") // OPEN, CLOSED, PREGNANT

  animalId    String
  animal      EquineAnimal @relation(fields: [animalId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  inseminations Insemination[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SemenCollection {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  volume      Float?   // ml
  concentration Int?   // espermatozoides/ml
  motility    Float?   // %
  observations String?

  stallionId  String
  stallion    EquineAnimal @relation(fields: [stallionId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Insemination {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  type        String   // ARTIFICIAL, NATURAL
  observations String?

  cycleId     String
  cycle       ReproductiveCycle @relation(fields: [cycleId], references: [id])
  
  mareId      String
  mare        EquineAnimal @relation(fields: [mareId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// === MÓDULO GADO LEITEIRO ===

model DairyAnimal {
  id          String   @id @default(cuid())
  tag         String   // Brinco/Identificação
  name        String?
  breed       String?
  birthDate   DateTime?

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  lactations  LactationCycle[]
  productions MilkProduction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LactationCycle {
  id          String   @id @default(cuid())
  startDate   DateTime @default(now())
  endDate     DateTime?
  status      String   @default("ACTIVE") // ACTIVE, DRY

  animalId    String
  animal      DairyAnimal @relation(fields: [animalId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model MilkProduction {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  amount      Float    // Litros
  period      String?  // MANHA, TARDE

  animalId    String
  animal      DairyAnimal @relation(fields: [animalId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// === MÓDULO GADO DE CORTE (ENGORDA) ===

model BeefLot {
  id          String   @id @default(cuid())
  name        String
  description String?

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  animals     BeefAnimal[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BeefAnimal {
  id          String   @id @default(cuid())
  tag         String   
  breed       String?
  initialWeight Float?
  targetWeight  Float?

  lotId       String?
  lot         BeefLot? @relation(fields: [lotId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  weighings   Weighing[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Weighing {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  weight      Float
  
  animalId    String
  animal      BeefAnimal @relation(fields: [animalId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// FINANCEIRO
model Transaction {
  id          String   @id @default(cuid())
  type        String   // "INCOME" (Receita) ou "EXPENSE" (Despesa)
  amount      Decimal  @db.Decimal(10, 2)
  description String
  date        DateTime @default(now())
  
  module      String   @default("CRECHE") // "CRECHE", "CLINICA", "EQUINOS", "LEITE", "CORTE", "GERAL"
  method      String   @default("PIX") // "PIX", "CREDITO", "DEBITO", "DINHEIRO"

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  bookingId   String?  
  booking     Booking? @relation(fields: [bookingId], references: [id])
  
  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  
  petSitterAppointmentId String?
  petSitterAppointment   PetSitterAppointment? @relation(fields: [petSitterAppointmentId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  quantity    Int      @default(0)   
  minStock    Int      @default(5)   
  
  price       Decimal  @db.Decimal(10, 2) 
  costPrice   Decimal? @db.Decimal(10, 2) 
  
  unit        String   @default("UN") 
  expiryDate  DateTime? 

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// === MÓDULO PET SITTER ===

model PetSitterAppointment {
  id          String   @id @default(cuid())
  date        DateTime
  time        String   // Horário da visita (ex: "14:30")
  status      String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELED
  
  // Informações de localização e combustível
  address     String?  // Endereço específico (se diferente do cadastro)
  distanceKm  Decimal? @db.Decimal(10, 2) // Distância em KM
  fuelCost    Decimal? @db.Decimal(10, 2) // Custo calculado de combustível
  
  // Recorrência
  isRecurring Boolean  @default(false)
  recurrencePattern String? // Ex: "WEEKLY_WED" (toda quarta), "WEEKLY_MON_FRI" (segunda e sexta)
  recurrenceEndDate DateTime? // Data final da recorrência
  parentAppointmentId String? // ID do agendamento pai (se for uma ocorrência de recorrência)
  
  // Financeiro
  serviceValue Decimal  @db.Decimal(10, 2) // Valor do serviço
  totalCost    Decimal  @db.Decimal(10, 2) // Valor total (serviço + combustível)
  isPaid       Boolean  @default(false)
  paymentMethod String? // PIX, CREDITO, DEBITO, DINHEIRO
  
  notes       String?  @db.Text // Observações e instruções
  
  // Relacionamentos
  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  transactions Transaction[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
