generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  GERENTE
  FINANCEIRO
  FUNCIONARIO
  RECEPCAO
}

// 2. Modelo de Agendamento
model Appointment {
  id          String   @id @default(cuid())
  date        DateTime
  reason      String
  notes       String?
  status      String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELED
  
  // === NOVOS CAMPOS FINANCEIROS ===
  totalCost   Decimal? @db.Decimal(10, 2) // Valor cobrado
  isPaid      Boolean  @default(false)      // Se já foi pago
  paymentMethod String?                     // PIX, CREDITO, etc.
  
  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])
  
  veterinarianId String
  veterinarian   User    @relation("VetAppointments", fields: [veterinarianId], references: [id])

  services Service[]

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  medicalRecord MedicalRecord?
  
  // Relacionamento com a transação financeira gerada
  transactions Transaction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 3. Modelo de Prontuário Médico
model MedicalRecord {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  
  complaint   String   // Queixa principal (Anamnese)
  diagnosis   String?  // Diagnóstico
  prescription String? @db.Text // Receita / Prescrição
  notes       String?  @db.Text // Exame físico / Detalhes

  appointmentId String? @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])

  veterinarianId String
  veterinarian   User    @relation("VetRecords", fields: [veterinarianId], references: [id])

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
// === MODELS ===



model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  document    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  modules     TenantModule[]

  transactions Transaction[]
  
  // Dados Módulo Creche
  customers   Customer[]
  pets        Pet[]
  kennels     Kennel[]
  bookings    Booking[]

  services Service[]
  products Product[]

  appointments    Appointment[]
  medicalRecords  MedicalRecord[]
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  role        Role   @default(FUNCIONARIO) // GERENTE, FINANCEIRO, FUNCIONARIO, RECEPCAO
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())

  vetAppointments Appointment[] @relation("VetAppointments")
  vetRecords      MedicalRecord[] @relation("VetRecords")
}

model Module {
  id          String   @id
  name        String
  description String?
  price       Decimal  @default(0.0)

  tenants     TenantModule[]
}

model TenantModule {
  id        String   @id @default(cuid())
  tenantId  String
  moduleId  String
  isActive  Boolean  @default(true)
  expiresAt DateTime?

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  module    Module   @relation(fields: [moduleId], references: [id])

  @@unique([tenantId, moduleId])
}

// === ENTIDADES DO MÓDULO GERAL E CRECHE ===

model Customer {
  id          String   @id @default(cuid())
  name        String
  
  email       String?
  phone       String?
  address     String?
  cpf         String?

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  pets        Pet[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Pet {
  id          String   @id @default(cuid())
  name        String
  species     String
  breed       String?
  weight      Float?
  birthDate   DateTime?
  
  // NOVOS CAMPOS DE SAÚDE
  allergies   String?  // Ex: "Alergia a Frango"
  foodRestrictions String? // Ex: "Ração Hipoalergênica apenas"
  vetName     String?  // Nome do Veterinário externo
  vetPhone    String?  // Telefone do Vet
  notes       String?  // Observações gerais de comportamento
  

  ownerId     String
  owner       Customer @relation(fields: [ownerId], references: [id])
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  bookings    Booking[]
  medications PetMedication[] // Relação com remédios
  logs        PetLog[]        // Relação com histórico

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  appointments    Appointment[]
  medicalRecords  MedicalRecord[]
}

model PetMedication {
  id          String   @id @default(cuid())
  name        String   // Ex: "Apoquel"
  dosage      String   // Ex: "1/2 comprimido"
  frequency   String   // Ex: "A cada 12h"
  startDate   DateTime?
  endDate     DateTime?
  active      Boolean  @default(true)

  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])
  createdAt   DateTime @default(now())
}

// NOVO MODEL: Diário de Bordo (Logs)
model PetLog {
  id          String   @id @default(cuid())
  type        String   // FOOD, MEDICINE, EXERCISE, HEALTH, OBSERVATION
  description String   // "Comeu tudo", "Tomou remédio", "Vomitou"
  date        DateTime @default(now())
  performedBy String?

  petId       String
  pet         Pet      @relation(fields: [petId], references: [id])
  createdAt   DateTime @default(now())
}

model Kennel {
  id          String      @id @default(cuid())
  name        String
  
  // ADICIONE ESTE CAMPO NOVO:
  size        String?     // Tamanho (P, M, G)
  dailyRate   Decimal     @default(0.0) @db.Decimal(10, 2)

  status      String      @default("AVAILABLE") 
  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  bookings    Booking[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  capacity    Int      @default(1)
}

model Booking {
  id          String    @id @default(cuid())
  
  startDate   DateTime  @default(now()) // Hora que entrou
  endDate     DateTime? // Hora que saiu (Null = ainda está lá)
  status      String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED

  totalCost   Decimal?  @db.Decimal(10, 2)
  
  transactions Transaction[]
  
  petId       String
  pet         Pet       @relation(fields: [petId], references: [id])
  
  kennelId    String
  kennel      Kennel    @relation(fields: [kennelId], references: [id])
  
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  services    BookingService[]
}

model Service {
  id          String   @id @default(cuid())
  name        String   // Ex: "Banho", "Tosa"
  price       Decimal  @db.Decimal(10, 2)
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  bookingServices BookingService[]

  appointments Appointment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BookingService {
  id          String   @id @default(cuid())
  price       Decimal  @db.Decimal(10, 2) // Salva o preço no momento da adição
  createdAt   DateTime @default(now())

  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id])
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
}

// FINANCEIRO
model Transaction {
  id          String   @id @default(cuid())
  type        String   // "INCOME" (Receita) ou "EXPENSE" (Despesa)
  amount      Decimal  @db.Decimal(10, 2)
  description String
  date        DateTime @default(now())
  
  module      String   @default("CRECHE") // "CRECHE", "CLINICA", "GERAL"
  method      String   @default("PIX") // "PIX", "CREDITO", "DEBITO", "DINHEIRO"

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  // Opcional: para saber de qual reserva veio esse dinheiro
  bookingId   String?  
  booking     Booking? @relation(fields: [bookingId], references: [id])

  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  quantity    Int      @default(0)   // Quantidade atual
  minStock    Int      @default(5)   // Estoque mínimo para alerta
  
  price       Decimal  @db.Decimal(10, 2) // Preço de Venda (se for vendido)
  costPrice   Decimal? @db.Decimal(10, 2) // Custo (para relatório de lucro)
  
  unit        String   @default("UN") // UN, ML, KG, CX
  expiryDate  DateTime? // Validade

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}